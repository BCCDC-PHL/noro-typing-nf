#!/usr/bin/env Rscript
args = commandArgs(trailingOnly=TRUE)

# Script to generate coverage plots

# Load packages

library(tidyverse)
library(ggplot2)
library(scales)

# Read in data
# Uses a coverage file, generated by samtools depth [CID_alignment_filtered_sorted.bam]
# renames into segment, position depth,
# then splits out the segment to extract the segment name

coverage <- read_tsv(file = args[1],
                       col_names=F) %>%
  rename(segment = X1,
         position = X2,
         depth = X3) %>%
  separate(segment, into = c("Accession", "i1", "i2", "genotype", "i3", "i4", "strain", "length", "type"))


Accession <- coverage %>%
  distinct(Accession)


# Plot coverage:
# Use a line-plot, with x-axis as position and depth on the y-axis
# Facet-wrap by segment_name and subtype - hopefully this will grab both when there is more than one 
# subtype - otherwise it will merge them all together, which we do not want.
# Use a log10 transform on the y-axis to allow better visualiztion of the range of depths we are likel to see
# (this was done on ncov tools output)
# output as a pdf
p <- coverage %>%
  ggplot(aes(x = position, y = depth))+
  geom_line()+
  labs(title = Accession)+
  scale_y_log10(labels=comma)+
  facet_wrap(vars(genotype), nrow = 2)
  

ggsave(plot = p, filename = args[2], device = "pdf", width = 8, units = "in")

  